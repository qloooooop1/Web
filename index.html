    function displayTickets() {
        ticketList.innerHTML = '';
        const user = JSON.parse(localStorage.getItem('user'));
        const isAdmin = user && user.isAdmin;
        if (user) {
            ticketsSection.classList.add('active');
            ticketForm.classList.add('active');
            tickets.forEach((ticket, index) => {
                if (isAdmin || ticket.username === user.username) {
                    const ticketDiv = document.createElement('div');
                    ticketDiv.classList.add('ticket');
                    ticketDiv.innerHTML = `
                        <h4>${ticket.title}</h4>
                        <p>${ticket.message}</p>
                        <p>بواسطة: ${ticket.username}</p>
                        <p>تاريخ الإنشاء: ${ticket.createdAt}</p>
                        <p>آخر تحديث: ${ticket.updatedAt}</p>
                        <p>الحالة: <span class="${ticket.status === 'open' ? 'status-open' : 'status-closed'}">${ticket.status === 'open' ? 'مفتوحة' : 'مغلقة'}</span></p>
                        ${ticket.responses.length ? '<p>الردود:</p><ul>' + ticket.responses.map(r => `<li>${r.text} (بواسطة: ${r.by}) - ${r.at}</li>`).join('') + '</ul>' : ''}
                        <div class="actions">
                            ${ticket.status === 'open' ? `<button onclick="respondToTicket(${ticket.id})">رد</button>` : ''}
                            ${ticket.status === 'open' ? `<button onclick="closeTicket(${ticket.id})">إغلاق</button>` : ''}
                            <button onclick="deleteTicket(${ticket.id})">حذف</button>
                            ${isAdmin && ticket.username !== 'admin' ? `<button onclick="deleteUserAccount('${ticket.username}')">حذف الحساب</button>` : ''}
                        </div>
                    `;
                    ticketList.appendChild(ticketDiv);
                    gsap.to(ticketDiv, { opacity: 1, y: 0, duration: 0.5, delay: index * 0.1 });
                }
            });
        }
    }

    window.respondToTicket = function(id) {
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) return;
        const response = prompt('أدخل ردك على التذكرة:');
        if (response) {
            tickets = tickets.map(ticket => {
                if (ticket.id === id) {
                    ticket.responses.push({
                        text: response,
                        by: user.username,
                        at: new Date().toLocaleString()
                    });
                    ticket.updatedAt = new Date().toLocaleString();
                }
                return ticket;
            });
            localStorage.setItem('tickets', JSON.stringify(tickets));
            displayTickets();
            Toastify({
                text: "تم إرسال الرد",
                duration: 3000,
                style: { background: "#ff4040" }
            }).showToast();
        }
    };

    window.closeTicket = function(id) {
        tickets = tickets.map(ticket => {
            if (ticket.id === id) {
                ticket.status = 'closed';
                ticket.updatedAt = new Date().toLocaleString();
            }
            return ticket;
        });
        localStorage.setItem('tickets', JSON.stringify(tickets));
        displayTickets();
        Toastify({
            text: "تم إغلاق التذكرة",
            duration: 3000,
            style: { background: "#ff4040" }
        }).showToast();
    };

    window.deleteTicket = function(id) {
        tickets = tickets.filter(ticket => ticket.id !== id);
        localStorage.setItem('tickets', JSON.stringify(tickets));
        displayTickets();
        Toastify({
            text: "تم حذف التذكرة",
            duration: 3000,
            style: { background: "#ff4040" }
        }).showToast();
    };

    window.deleteUserAccount = function(username) {
        const user = JSON.parse(localStorage.getItem('user'));
        if (user && user.isAdmin) {
            if (confirm(`هل أنت متأكد من حذف حساب ${username}؟`)) {
                tickets = tickets.filter(ticket => ticket.username !== username);
                if (user.username === username) {
                    localStorage.removeItem('user');
                }
                localStorage.setItem('tickets', JSON.stringify(tickets));
                updateUserUI();
                Toastify({
                    text: `تم حذف حساب ${username}`,
                    duration: 3000,
                    style: { background: "#ff4040" }
                }).showToast();
            }
        }
    };

    updateUserUI();

    // Skill Popups
    const skillCards = document.querySelectorAll('.skill-card');
    const popups = document.querySelectorAll('.popup');
    const closeBtns = document.querySelectorAll('.close-btn');

    skillCards.forEach(card => {
        card.addEventListener('click', () => {
            const popupId = card.getAttribute('data-popup');
            const popup = document.getElementById(popupId);
            if (!popup.classList.contains('active')) {
                popups.forEach(p => p.classList.remove('active'));
                popup.classList.add('active');
            }
        });
    });

    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            btn.parentElement.classList.remove('active');
        });
    });

    document.addEventListener('click', (e) => {
        const activePopup = document.querySelector('.popup.active');
        if (activePopup && !activePopup.contains(e.target) && !e.target.closest('.skill-card')) {
            activePopup.classList.remove('active');
        }
    });

    // Contact Popup
    const contactBtn = document.getElementById('contactBtn');
    const heroContactBtn = document.getElementById('heroContactBtn');
    const contactPopup = document.getElementById('contactPopup');
    const contactForm = document.getElementById('contactForm');

    [contactBtn, heroContactBtn].forEach(btn => {
        if (btn) {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                contactPopup.classList.add('active');
            });
        }
    });

    contactForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = contactForm.name.value.trim();
        const email = contactForm.email.value.trim();
        const message = contactForm.message.value.trim();

        if (!name || !email || !message) {
            Toastify({
                text: "يرجى ملء جميع الحقول",
                duration: 3000,
                style: { background: "#ff4040" }
            }).showToast();
            return;
        }

        if (!/\S+@\S+\.\S+/.test(email)) {
            Toastify({
                text: "البريد الإلكتروني غير صحيح",
                duration: 3000,
                style: { background: "#ff4040" }
            }).showToast();
            return;
        }

        fetch('/', {
            method: 'POST',
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                'form-name': 'contact',
                'name': name,
                'email': email,
                'message': message
            }).toString()
        }).then(() => {
            Toastify({
                text: "تم إرسال الرسالة بنجاح",
                duration: 3000,
                style: { background: "#ff4040" }
            }).showToast();
            contactForm.reset();
            contactPopup.classList.remove('active');
        });
    });
</script>